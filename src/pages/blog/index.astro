---
import Base from "../../../src/layouts/Base.astro";
import { getCollection } from "astro:content";
const posts = (await getCollection('posts')).sort((a,b) => (a.data.date < b.data.date ? 1 : -1));
const pageTitle = 'Journal · Kateiso';
const pageDesc = 'Journal entries on intelligent creative systems, XR, and workflow design.';
---
<Base title={pageTitle} description={pageDesc}>
  <section class="section">
    <div class="section__intro">
      <h1>Journal</h1>
      <p class="section__lede">Essays, field notes, and toolkits documenting how creative systems and intelligent workflows come together.</p>
    </div>

    <div class="section__intro section__intro--split">
      <input id="search" type="search" placeholder="Search posts and About…" style="padding:0.7rem 1rem;border:1px solid var(--color-border);border-radius:12px;width:min(480px, 100%);" />
      <span aria-live="polite" id="search-count" style="color:var(--color-text-muted)"></span>
    </div>

    <div class="blog-list" id="results">
      {posts.map((p) => (
        <article class="blog-card">
          <p class="blog-card__meta">{new Date(p.data.date).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })} · {p.data.type}</p>
          <h2><a href={`/blog/posts/${p.slug}.html`}>{p.data.title}</a></h2>
          <p class="blog-card__summary">{p.data.summary}</p>
        </article>
      ))}
    </div>
  </section>

  <script>
    const input = document.getElementById('search');
    const results = document.getElementById('results');
    const counter = document.getElementById('search-count');
    let index = [];
    fetch('/assets/data/search.json')
      .then((r) => r.json())
      .then((data) => (index = data.items || []))
      .catch(() => (index = []));

    function render(items) {
      results.innerHTML = items.map((it) => `
        <article class="blog-card">
          <p class="blog-card__meta">${it.date ? new Date(it.date).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : ''} ${it.type ? '· ' + it.type : ''}</p>
          <h2><a href="${it.slug}">${it.title}</a></h2>
          <p class="blog-card__summary">${it.summary || ''}</p>
        </article>
      `).join('');
      counter.textContent = `${items.length} result${items.length === 1 ? '' : 's'}`;
    }

    input?.addEventListener('input', () => {
      const q = input.value.trim().toLowerCase();
      if (!q) {
        // Reset to server-rendered posts
        counter.textContent = '';
        return;
      }
      const filtered = index.filter((it) =>
        [it.title, it.summary, (it.tags || []).join(' ')].some((f) => (f || '').toLowerCase().includes(q))
      );
      render(filtered);
    });
  </script>
</Base>

