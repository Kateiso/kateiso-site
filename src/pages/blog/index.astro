---
import Base from "../../../src/layouts/Base.astro";
import { getCollection } from "astro:content";
const posts = (await getCollection('posts')).sort((a,b) => (a.data.date < b.data.date ? 1 : -1));
const pageTitle = '博客 · Kateiso';
const pageDesc = '记录 AI into XR 与餐饮数字化的每一次试验、复盘与感想。';
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: pageTitle,
  description: pageDesc,
  inLanguage: 'zh-Hans',
  url: 'https://kateiso.dev/blog.html'
};
---
<Base
  title={pageTitle}
  description={pageDesc}
  lang="zh-Hans"
  canonical="/blog.html"
  alternates={[{ href: '/en/blog.html', hrefLang: 'en' }]}
  languageToggle={{ href: '/en/blog.html', label: 'EN', ariaLabel: 'View English blog' }}
  jsonLd={jsonLd}
>
  <section class="section">
    <div class="section__intro">
      <h1>博客</h1>
      <p class="section__lede">在威海、北京、兰开夏之间移动时写下的 XR 与餐饮运营观察。</p>
    </div>

    <div class="section__intro section__intro--split">
      <input id="search" type="search" placeholder="搜索文章…" style="padding:0.7rem 1rem;border:1px solid var(--color-border);border-radius:12px;width:min(480px, 100%);" />
      <span aria-live="polite" id="search-count" style="color:var(--color-text-muted)"></span>
    </div>

    <div class="blog-list" id="results">
      {posts.map((p) => (
        <article class="blog-card">
          <p class="blog-card__meta">{new Date(p.data.date).toLocaleDateString('zh-CN', { year: 'numeric', month: 'long' })} · {p.data.type}</p>
          <h2><a href={`/blog/posts/${p.slug}.html`}>{p.data.title}</a></h2>
          <p class="blog-card__summary">{p.data.summary}</p>
        </article>
      ))}
    </div>
  </section>

  <script>
    const input = document.getElementById('search');
    const results = document.getElementById('results');
    const counter = document.getElementById('search-count');
    let index = [];
    fetch('/assets/data/search.json')
      .then((r) => r.json())
      .then((data) => (index = data.items || []))
      .catch(() => (index = []));

    function render(items) {
      results.innerHTML = items.map((it) => `
        <article class="blog-card">
          <p class="blog-card__meta">${it.date ? new Date(it.date).toLocaleDateString('zh-CN', { year: 'numeric', month: 'long' }) : ''} ${it.type ? '· ' + it.type : ''}</p>
          <h2><a href="${it.slug}">${it.title}</a></h2>
          <p class="blog-card__summary">${it.summary || ''}</p>
        </article>
      `).join('');
      counter.textContent = `${items.length} 条结果`;
    }

    input?.addEventListener('input', () => {
      const q = input.value.trim().toLowerCase();
      if (!q) {
        // Reset to server-rendered posts
        counter.textContent = '';
        return;
      }
      const filtered = index.filter((it) =>
        [it.title, it.summary, (it.tags || []).join(' ')].some((f) => (f || '').toLowerCase().includes(q))
      );
      render(filtered);
    });
  </script>
</Base>
